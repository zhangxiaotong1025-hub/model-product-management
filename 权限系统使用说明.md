# 权限系统使用说明

## 核心设计原则

### 1. 企业是能力与资产的容器
- ❌ 企业不是角色
- ❌ 企业不是权限集合
- ✅ 企业是能力（产品+权益）与资产（品牌、模型、商品等）的容器

### 2. 权限判断第一维度是「产品」
- 所有权限判断必须先确定是哪个产品
- 不同产品有独立的权益配置
- 产品是权限的主开关

### 3. 菜单只是 UI 表现
- 菜单显示不等于有权限
- 菜单隐藏不等于没权限
- 必须通过权限引擎进行实际判断

### 4. 禁止基于企业类型进行运行期判断
- 企业类型（卖场、品牌商等）仅用于：
  - UI 展示和筛选
  - 创建时的初始化建议
  - 统计分析
- ❌ 不能用于权限判断
- ❌ 不能用于功能开关

## 权限判断流程

### 统一判断顺序（4步检查）

```javascript
// 使用权限引擎进行判断
const engine = new PermissionEngine();

const result = await engine.checkPermission({
    enterpriseId: 'ENT-001',      // 企业ID
    productCode: 'domestic_3d',   // 产品代码
    featureCode: '3d_rendering',  // 功能代码（可选）
    assetType: 'brand',           // 资产类型（可选）
    assetId: 'BRAND-001',         // 资产ID（可选）
    userId: 'USER-001',           // 用户ID
    action: 'render:create'       // 操作动作
});

if (result.allowed) {
    // 允许操作
} else {
    // 拒绝操作，原因：result.reason
}
```

### 第一步：检查企业是否启用该产品

```javascript
// 检查企业是否启用了"国内3D"产品
const productCheck = await engine.checkEnterpriseProduct('ENT-001', 'domestic_3d');

if (!productCheck.enabled) {
    // 企业未启用该产品，直接拒绝
    return false;
}
```

### 第二步：检查产品下是否具备对应能力/权益

```javascript
// 检查企业在"国内3D"产品下是否开通了"3D渲染"功能
const entitlementCheck = await engine.checkEntitlement(
    'ENT-001',
    'domestic_3d',
    '3d_rendering'
);

if (!entitlementCheck.granted) {
    // 企业未开通该功能权益，拒绝
    return false;
}
```

### 第三步：检查是否满足资产边界要求

```javascript
// 检查要访问的品牌是否属于该企业
const assetCheck = await engine.checkAssetBoundary(
    'ENT-001',
    'brand',
    'BRAND-001'
);

if (!assetCheck.accessible) {
    // 资产不在企业边界内，拒绝
    return false;
}
```

### 第四步：检查用户角色是否允许该操作

```javascript
// 检查用户在企业中的角色是否允许"创建渲染"操作
const roleCheck = await engine.checkUserRole(
    'USER-001',
    'ENT-001',
    'render:create'
);

if (!roleCheck.allowed) {
    // 用户角色不允许该操作，拒绝
    return false;
}
```

## 核心实体

### Enterprise（企业）
```javascript
{
    id: 'ENT-001',
    name: '阿里巴巴集团',
    type: 'brand',              // 仅用于展示，不参与权限判断
    status: 'active',
    products: [                 // 企业启用的产品列表
        {
            productCode: 'domestic_3d',
            enabled: true,
            features: {         // 功能权益
                '3d_rendering': true,
                'construction_drawing': true
            },
            quotas: {           // 配额权益
                'render_2k_monthly': 1000,
                'render_4k_monthly': 100
            },
            services: {         // 增值服务
                'priority_rendering': true,
                'api_access': false
            }
        }
    ],
    assets: {                   // 企业资产
        brands: ['BRAND-001', 'BRAND-002'],
        supplyChains: ['SC-001']
    }
}
```

### Product（产品）
```javascript
{
    code: 'domestic_3d',
    name: '国内3D',
    availableFeatures: [
        '3d_rendering',
        'construction_drawing',
        'model_management'
    ],
    availableQuotas: [
        'render_2k_monthly',
        'render_4k_monthly',
        'storage_gb'
    ],
    availableServices: [
        'priority_rendering',
        'api_access'
    ]
}
```

### Entitlement（权益）
```javascript
// Feature（功能权益）
{
    code: '3d_rendering',
    type: 'feature',
    name: '3D渲染',
    productCode: 'domestic_3d'
}

// Quota（配额权益）
{
    code: 'render_2k_monthly',
    type: 'quota',
    name: '2K渲染次数（次/月）',
    productCode: 'domestic_3d',
    limit: 1000,
    used: 500
}

// Service（增值服务）
{
    code: 'priority_rendering',
    type: 'service',
    name: '优先渲染',
    productCode: 'domestic_3d'
}
```

### Asset（资产）
```javascript
{
    type: 'brand',              // 资产类型：brand/supply_chain/model/product
    id: 'BRAND-001',
    enterpriseId: 'ENT-001',
    metadata: {
        name: '顾家家居',
        relation: 'own'         // own/agent/none
    }
}
```

### Role（角色）
```javascript
{
    id: 'ROLE-001',
    name: 'admin',
    permissions: [
        'render:create',
        'render:read',
        'render:update',
        'render:delete',
        'model:*'               // * 表示所有操作
    ]
}
```

## 使用示例

### 示例1：检查3D渲染权限

```javascript
// 场景：用户点击"创建渲染任务"按钮
async function handleCreateRender() {
    const engine = new PermissionEngine();
    
    // 完整权限检查
    const result = await engine.checkPermission({
        enterpriseId: getCurrentEnterpriseId(),
        productCode: 'domestic_3d',
        featureCode: '3d_rendering',
        userId: getCurrentUserId(),
        action: 'render:create'
    });
    
    if (!result.allowed) {
        showError(result.reason);
        return;
    }
    
    // 检查配额
    const quotaResult = await engine.checkQuota(
        getCurrentEnterpriseId(),
        'domestic_3d',
        'render_2k_monthly',
        1
    );
    
    if (!quotaResult.sufficient) {
        showError('渲染配额不足');
        return;
    }
    
    // 执行渲染
    createRenderTask();
}
```

### 示例2：检查品牌模型访问权限

```javascript
// 场景：用户访问某个品牌的模型列表
async function loadBrandModels(brandId) {
    const engine = new PermissionEngine();
    
    const result = await engine.checkPermission({
        enterpriseId: getCurrentEnterpriseId(),
        productCode: 'domestic_3d',
        featureCode: 'model_management',
        assetType: 'brand',
        assetId: brandId,
        userId: getCurrentUserId(),
        action: 'model:read'
    });
    
    if (!result.allowed) {
        showError('无权访问该品牌的模型');
        return;
    }
    
    // 加载模型列表
    fetchModels(brandId);
}
```

### 示例3：动态渲染菜单

```javascript
// 场景：根据权限动态显示菜单
async function renderMenu() {
    const engine = new PermissionEngine();
    
    const menuItems = [
        {
            name: '3D渲染',
            icon: 'fa-cube',
            context: {
                enterpriseId: getCurrentEnterpriseId(),
                productCode: 'domestic_3d',
                featureCode: '3d_rendering',
                userId: getCurrentUserId(),
                action: 'render:read'
            }
        },
        {
            name: '施工图生成',
            icon: 'fa-file-alt',
            context: {
                enterpriseId: getCurrentEnterpriseId(),
                productCode: 'domestic_3d',
                featureCode: 'construction_drawing',
                userId: getCurrentUserId(),
                action: 'drawing:read'
            }
        }
    ];
    
    // 批量检查权限
    const results = await engine.checkPermissionBatch(
        menuItems.map(item => item.context)
    );
    
    // 只显示有权限的菜单
    const allowedMenus = menuItems.filter((item, index) => results[index].allowed);
    
    renderMenuItems(allowedMenus);
}
```

### 示例4：上传公有模型权限检查

```javascript
// 场景：检查是否可以上传公有模型（需要品牌关系为"own"）
async function checkPublicModelUpload(brandId) {
    const engine = new PermissionEngine();
    
    // 1. 检查产品和功能权限
    const permissionResult = await engine.checkPermission({
        enterpriseId: getCurrentEnterpriseId(),
        productCode: 'domestic_3d',
        featureCode: 'model_management',
        userId: getCurrentUserId(),
        action: 'model:create'
    });
    
    if (!permissionResult.allowed) {
        return { allowed: false, reason: permissionResult.reason };
    }
    
    // 2. 检查品牌资产
    const assetResult = await engine.checkAssetBoundary(
        getCurrentEnterpriseId(),
        'brand',
        brandId
    );
    
    if (!assetResult.accessible) {
        return { allowed: false, reason: '品牌不属于当前企业' };
    }
    
    // 3. 检查品牌关系（必须是"own"才能上传公有模型）
    const brand = assetResult.asset;
    if (brand.metadata.relation !== 'own') {
        return { 
            allowed: false, 
            reason: '只有拥有品牌的企业才能上传公有模型' 
        };
    }
    
    return { allowed: true };
}
```

## 快捷辅助函数

```javascript
// 检查功能权限
const hasPermission = await hasFeaturePermission(
    'ENT-001',
    'domestic_3d',
    '3d_rendering',
    'USER-001',
    'render:create'
);

// 检查资产访问权限
const canAccess = await hasAssetPermission(
    'ENT-001',
    'domestic_3d',
    'brand',
    'BRAND-001',
    'USER-001',
    'model:read'
);

// 检查配额
const hasEnoughQuota = await hasQuota(
    'ENT-001',
    'domestic_3d',
    'render_2k_monthly',
    10  // 需要10次
);
```

## 常见错误

### ❌ 错误示例1：基于企业类型判断权限

```javascript
// 错误！不要这样做
if (enterprise.type === 'brand') {
    // 允许上传公有模型
    allowPublicModelUpload();
}
```

**正确做法**：
```javascript
// 正确：检查品牌资产的关系
const asset = await getAsset('brand', brandId);
if (asset.metadata.relation === 'own') {
    allowPublicModelUpload();
}
```

### ❌ 错误示例2：仅根据菜单判断权限

```javascript
// 错误！菜单显示不等于有权限
if (menuVisible) {
    executeAction();
}
```

**正确做法**：
```javascript
// 正确：执行操作前必须检查权限
const result = await engine.checkPermission({...});
if (result.allowed) {
    executeAction();
}
```

### ❌ 错误示例3：跳过权限检查步骤

```javascript
// 错误！不能跳过任何步骤
if (hasRole('admin')) {
    // 直接执行
    executeAction();
}
```

**正确做法**：
```javascript
// 正确：必须按顺序检查所有步骤
const result = await engine.checkPermission({
    enterpriseId,
    productCode,
    featureCode,
    assetType,
    assetId,
    userId,
    action
});
```

## API 接口设计建议

### 后端接口应该返回的数据结构

```javascript
// GET /api/enterprises/{enterpriseId}/products
{
    "success": true,
    "data": [
        {
            "productCode": "domestic_3d",
            "enabled": true,
            "features": {
                "3d_rendering": true,
                "construction_drawing": true
            },
            "quotas": {
                "render_2k_monthly": {
                    "limit": 1000,
                    "used": 500,
                    "remaining": 500
                }
            },
            "services": {
                "priority_rendering": true
            }
        }
    ]
}

// POST /api/permissions/check
{
    "enterpriseId": "ENT-001",
    "productCode": "domestic_3d",
    "featureCode": "3d_rendering",
    "assetType": "brand",
    "assetId": "BRAND-001",
    "userId": "USER-001",
    "action": "render:create"
}

// Response
{
    "success": true,
    "data": {
        "allowed": true,
        "reason": "权限检查通过",
        "details": {
            "productCheck": { "enabled": true },
            "entitlementCheck": { "granted": true },
            "assetCheck": { "accessible": true },
            "roleCheck": { "allowed": true }
        }
    }
}
```

## 总结

### 核心要点
1. ✅ 企业是能力与资产的容器
2. ✅ 产品是权限的第一维度
3. ✅ 严格按照4步顺序检查权限
4. ✅ 企业类型不参与运行期判断
5. ✅ 菜单只是UI表现，不能作为权限依据

### 实施清单
- [ ] 所有权限判断都使用 `PermissionEngine`
- [ ] 移除所有基于企业类型的权限判断逻辑
- [ ] 确保菜单显示与实际权限检查分离
- [ ] 在执行敏感操作前进行完整的4步权限检查
- [ ] 配额检查独立于权限检查之外
